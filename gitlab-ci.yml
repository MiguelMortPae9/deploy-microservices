stages:
  - quality
  - security
  - build
  - test
  - deploy

laravel/pint:
  stage: quality
  image: php:8.4-cli
  variables:
    COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer/cache"
  cache:
    key: ${CI_COMMIT_REF_SLUG}-composer
    paths:
      - .composer/cache # Cache de Composer
  before_script:
    - echo "Instalando dependencias del sistema..."
    - apt-get update && apt-get install -y git unzip curl libpng-dev libjpeg-dev libfreetype6-dev libxml2-dev libzip-dev libonig-dev libicu-dev libpq-dev
    - echo "Configurando PHP..."
    - docker-php-ext-install bcmath gd intl mbstring pdo pdo_pgsql xml zip
    - echo "Descargando Composer..."
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  script:
    - echo "Instalando dependencias del proyecto..."
    - composer install --no-interaction --prefer-dist
    - echo "Ejecutando Pint..."
    - ./vendor/bin/pint --test
  only:
    - merge_requests
    - master
    - staging
  allow_failure: false

vulnerabilities_scan:
  stage: security
  image: returntocorp/semgrep
  script:
    - echo "🔍 Escaneo de vulnerabilidades con Semgrep"
    - semgrep --config=auto .
  only:
    - merge_requests
    - staging
    - master
  allow_failure: false

build_image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - echo "Construyendo la imagen Docker..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
    - docker build -t "$CI_REGISTRY_IMAGE:develop-$CI_COMMIT_SHORT_SHA" ./docker
    - docker push "$CI_REGISTRY_IMAGE:develop-$CI_COMMIT_SHORT_SHA"
    - docker tag "$CI_REGISTRY_IMAGE:develop-$CI_COMMIT_SHORT_SHA" "$CI_REGISTRY_IMAGE:develop-latest"
    - echo "IMAGE_TAG=$CI_REGISTRY_IMAGE:develop-$CI_COMMIT_SHORT_SHA" > build.env
  artifacts:
    reports:
      dotenv: build.env
  only:
    - merge_requests
    - staging
    - master

test_application:
  stage: test
  image: $IMAGE_TAG # usa la variable generada por el artifact
  needs:
    - job: build_image
      artifacts: true # indica que necesita los artifacts de build_image
  script:
    - echo "Ejecutando tests en la imagen $IMAGE_TAG"
    - php artisan test

deploy_application:
  stage: deploy
  image: alpine:3.20
  needs:
    - job: build_image
      artifacts: true
  variables:
    DEPLOY_ENV: "staging"
  before_script:
    - apk add --no-cache openssh-client docker-cli
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - printf "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
    - |
      ENV_UPPER=$(echo "$DEPLOY_ENV" | tr '[:lower:]' '[:upper:]')
      ENV_ENCRYPTED=$(printenv "ENV_${ENV_UPPER}_ENCRYPTED")
      ENV_KEY=$(printenv "ENV_${ENV_UPPER}_KEY")
      [ -n "$ENV_ENCRYPTED" ] && [ -n "$ENV_KEY" ] || { echo "Faltan variables ENV_${ENV_UPPER}_ENCRYPTED o ENV_${ENV_UPPER}_KEY"; exit 1; }
      export ENV_ENCRYPTED ENV_KEY
  script:
    - ssh -i ~/.ssh/id_ed25519 "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p \"$DEPLOY_PATH\""
    - ssh -i ~/.ssh/id_ed25519 "$DEPLOY_USER@$DEPLOY_HOST" "cat > \"$DEPLOY_PATH/.docker-compose.yml\"" < .docker-compose.yml
    - ssh -i ~/.ssh/id_ed25519 "$DEPLOY_USER@$DEPLOY_HOST" "docker login -u \"$CI_REGISTRY_USER\" -p \"$CI_REGISTRY_PASSWORD\" \"$CI_REGISTRY\" && docker pull \"$IMAGE_TAG\""
    - >
      printf "%s" "$ENV_ENCRYPTED" | \
      ssh -i ~/.ssh/id_ed25519 "$DEPLOY_USER@$DEPLOY_HOST" \
      "cd \"$DEPLOY_PATH\" && \
       docker run --rm -i \
         -v /dev/shm:/dev/shm \
         -w /var/www/html \
         \"$IMAGE_TAG\" \
         sh -lc 'cat > .env.encrypted && \
                 php artisan env:decrypt --force --key=\"$ENV_KEY\" --env=\"$DEPLOY_ENV\" && \
                 cp .env /dev/shm/.laravel.env && \
                 rm -f .env .env.encrypted'"
    - >
      ssh -i ~/.ssh/id_ed25519 "$DEPLOY_USER@$DEPLOY_HOST" \
      "cd \"$DEPLOY_PATH\" && \
       APP_IMAGE=\"$IMAGE_TAG\" APP_ENV_FILE=/dev/shm/.laravel.env HOST_HTTP_PORT=\"${HOST_HTTP_PORT:-80}\" CONTAINER_HTTP_PORT=\"${CONTAINER_HTTP_PORT:-8000}\" docker compose -f .docker-compose.yml up -d app | cat && \
       rm -f /dev/shm/.laravel.env"
    - >
      ssh -i ~/.ssh/id_ed25519 "$DEPLOY_USER@$DEPLOY_HOST" \
      "cd \"$DEPLOY_PATH\" && docker compose -f .docker-compose.yml exec -T app php artisan migrate --force"
  only:
    - staging
